---
alwaysApply: true
---

# プロジェクト仕様

## 概要
AI求人マッチングアプリケーション

## プロジェクトの目的
- 求職者と求人のマッチング
- AIを活用したレコメンド機能（将来的に）

## 技術スタック
- Laravel 12.x
- Livewire 3 + Volt (Functional)
- Flux UI Free
- Tailwind CSS v4
- Pest v4

## 認証システム
- Laravel Fortifyベースの認証（Livewire Starter Kit）
- 2要素認証対応
- セッション管理

## ルーティング規約
- リソースルート: 複数形（例: `/jobs`, `/applications`）
- 機能別ルート: 適切な命名（例: `/dashboard`, `/settings`）
- 認証必須ルート: `auth`ミドルウェア使用
- 名前付きルート必須

## ロール機能

### ユーザーロール
- `company`: 企業ユーザー（求人投稿、応募管理）
- `worker`: ワーカーユーザー（求人応募、応募一覧）

### ロールベースミドルウェア
- ミドルウェア名: `role`
- 実装クラス: `App\Http\Middleware\EnsureUserHasRole`
- 使用方法: `->middleware('role:company')` または `->middleware('role:worker')`
- 不正アクセス時: 403エラー（Access Denied）

### ログイン後のリダイレクト
- すべてのユーザー: `/dashboard` にリダイレクト
- プロフィール登録の有無に関わらず共通

## UI設計ルール

### 未実装機能へのリンク表示
段階的な実装を進める際（詳細画面→編集画面→登録画面の順）、未実装機能へのリンクには以下のルールを適用：

- 未実装機能へのリンクには「（準備中）」の文言を追加
- リンクは無効化する（`disabled` 属性を使用）
- 実装完了後、「（準備中）」を削除し、正しいリンクを設定

**実装例**:
```blade
<!-- 未実装時 -->
<flux:button disabled>
    編集（準備中）
</flux:button>

<!-- 実装後 -->
<flux:button :href="route('jobs.edit', $job)" wire:navigate>
    編集
</flux:button>
```

**実装手順**:
1. 詳細画面作成時：編集・削除ボタンを「（準備中）」で実装
2. 編集画面作成時：編集ボタンを有効化、「（準備中）」を削除
3. 登録画面作成時：新規作成ボタンを有効化、「（準備中）」を削除

## ポリシーと認可
- 各モデルに対応するPolicyクラス作成
- アクション実行前の認可チェック必須
- `$this->authorize()`メソッド使用

## バリデーション
- Form Requestクラス使用必須
- インラインバリデーション禁止
- 日本語エラーメッセージ
- カスタムバリデーションルールは適切に分離

---

## 実装済み機能

### 認証・アカウント管理

#### ログイン
- **ルート**: `GET/POST /login`
- **コンポーネント**: Fortify標準
- **機能**: メールアドレスとパスワードでログイン

#### ユーザー登録
- **ルート**: `GET/POST /register`
- **コンポーネント**: Fortify標準
- **機能**: 新規アカウント作成

#### パスワードリセット
- **ルート**: `GET/POST /password/reset`
- **コンポーネント**: Fortify標準
- **機能**: メール経由でのパスワードリセット

#### 2要素認証
- **ルート**: `/settings/two-factor`
- **コンポーネント**: `resources/views/livewire/settings/two-factor.blade.php`
- **機能**: 2FAの有効化・無効化、リカバリーコード管理

### 企業プロフィール管理

#### 企業登録画面
- **ルート**: `GET /company/register`、`POST /company/register`
- **ルート名**: `company.register`
- **コンポーネント**: `resources/views/livewire/company/register.blade.php`
- **ミドルウェア**: なし（未認証ユーザー向け）
- **機能**: ユーザー登録と企業プロフィールを同時登録
- **入力項目**:
  - name: 企業名（必須）
  - email: メールアドレス（必須、ユニーク）
  - password: パスワード（必須、8文字以上）
  - password_confirmation: パスワード確認（必須）
  - location_id: 所在地（必須、2段階選択：都道府県→市区町村）
  - address: 所在地住所（必須、200文字以内）
  - representative: 担当者名（必須、50文字以内）
  - phone_number: 担当者連絡先（必須、30文字以内）
- **処理**:
  - usersテーブルにユーザー登録（role='company'、name=企業名）
  - company_profilesテーブルにプロフィール登録
  - 登録成功後、企業詳細画面（company.profile）にリダイレクト
- **UI**:
  - ユーザー情報と企業プロフィール情報を1画面で入力
  - 2段階選択（都道府県→市区町村）の実装

#### 企業詳細画面
- **ルート**: `GET /company/profile`
- **ルート名**: `company.profile`
- **コンポーネント**: `resources/views/livewire/company/show.blade.php`
- **ミドルウェア**: `auth`, `role:company`
- **機能**: ログインユーザーの企業プロフィール表示
- **表示項目**:
  - 企業名（users.name）
  - 所在地（都道府県 市区町村、例：東京都 千代田区）
  - 所在地住所
  - 担当者名
  - 担当者連絡先
  - 登録日時
  - 更新日時
- **アクション**: 編集画面へのリンク

#### 企業編集画面
- **ルート**: `GET /company/edit`
- **ルート名**: `company.edit`
- **コンポーネント**: `resources/views/livewire/company/edit.blade.php`
- **ミドルウェア**: `auth`, `role:company`
- **機能**: ログインユーザーの企業プロフィール編集
- **入力項目**: 企業プロフィール項目のみ（location_id, address, representative, phone_number）
- **処理**:
  - バリデーション後、company_profilesテーブルを更新
  - 更新成功後、企業詳細画面（company.profile）にリダイレクト
- **UI**:
  - 既存データを初期表示
  - 2段階選択（都道府県→市区町村）の実装
- **注意**: 企業名（users.name）の変更は別途ユーザー情報編集機能で対応

#### 所在地の2段階選択仕様
- **都道府県選択**:
  - locationsテーブルから`city IS NULL`のデータを取得
  - `code`の昇順でソート
- **市区町村選択**:
  - 選択された都道府県に対応する市区町村を取得
  - `prefecture`が選択された都道府県と一致し、`city IS NOT NULL`のデータ
  - `code`の昇順でソート
- **連動動作**:
  - 都道府県を変更すると、市区町村の選択肢が更新される
  - 都道府県を変更すると、市区町村の選択はリセットされる

### ワーカープロフィール管理

#### ワーカー登録画面
- **ルート**: `GET /worker/register`、`POST /worker/register`
- **ルート名**: `worker.register`
- **コンポーネント**: `resources/views/livewire/worker/register.blade.php`
- **ミドルウェア**: なし（未認証ユーザー向け）
- **機能**: ユーザー登録とワーカープロフィールを同時登録
- **入力項目**:
  - name: 氏名（必須）
  - email: メールアドレス（必須、ユニーク）
  - password: パスワード（必須、8文字以上）
  - password_confirmation: パスワード確認（必須）
  - gender: 性別（必須、ラジオボタン：male, female, other）
  - birthdate: 生年月日（必須、年月日ドロップダウン）
  - skills: スキル（任意、200文字以内、テキストエリア）
  - experiences: 経験（任意、200文字以内、テキストエリア）
  - desired_jobs: 希望職種（任意、200文字以内）
  - desired_location_id: 希望勤務地（任意、2段階選択：都道府県→市区町村）
- **処理**:
  - usersテーブルにユーザー登録（role='worker'、name=氏名）
  - worker_profilesテーブルにプロフィール登録
  - 登録成功後、ワーカー詳細画面（worker.profile）にリダイレクト
- **UI**:
  - ユーザー情報とワーカープロフィール情報を1画面で入力
  - 年月日ドロップダウンの動的生成
  - 2段階選択（都道府県→市区町村、任意）の実装

#### ワーカー詳細画面
- **ルート**: `GET /worker/profile`
- **ルート名**: `worker.profile`
- **コンポーネント**: `resources/views/livewire/worker/show.blade.php`
- **ミドルウェア**: `auth`, `role:worker`
- **機能**: ログインユーザーのワーカープロフィール表示
- **表示項目**:
  - 氏名（users.name）
  - 性別（日本語表示：male=男性、female=女性、other=その他）
  - 生年月日と年齢（例：1990年5月15日（34歳））
  - スキル（改行表示対応、NULL時は「未設定」）
  - 経験（改行表示対応、NULL時は「未設定」）
  - 希望職種（NULL時は「未設定」）
  - 希望勤務地（都道府県 市区町村、NULL時は「未設定」）
  - 登録日時
  - 更新日時
- **アクション**: 編集画面へのリンク

#### ワーカー編集画面
- **ルート**: `GET /worker/edit`
- **ルート名**: `worker.edit`
- **コンポーネント**: `resources/views/livewire/worker/edit.blade.php`
- **ミドルウェア**: `auth`, `role:worker`
- **機能**: プロフィール編集
- **入力項目**: ワーカープロフィール項目のみ（gender, birthdate, skills, experiences, desired_jobs, desired_location_id）
- **処理**:
  - バリデーション後、worker_profilesテーブルを更新
  - 更新成功後、ワーカー詳細画面（worker.profile）にリダイレクト
- **注意**: 氏名（users.name）の変更は別途ユーザー情報編集機能で対応

#### 生年月日の年月日選択仕様
- **年選択**: 現在年 - 18歳 から 現在年 - 80歳 まで（降順）
- **月選択**: 1月〜12月
- **日選択**: 選択された年月に応じて動的に生成
  - 1, 3, 5, 7, 8, 10, 12月: 1〜31日
  - 4, 6, 9, 11月: 1〜30日
  - 2月: 閏年判定（28日または29日）
- **連動動作**:
  - 年または月を変更すると、日の選択肢が更新される
  - 選択中の日が新しい日数を超える場合、日選択はリセット

#### 希望勤務地の2段階選択仕様（任意）
- **都道府県選択**:
  - locationsテーブルから`city IS NULL`のデータを取得
  - `code`の昇順でソート
  - 「選択しない」オプションあり
- **市区町村選択**:
  - 選択された都道府県に対応する市区町村を取得
  - `prefecture`が選択された都道府県と一致し、`city IS NOT NULL`のデータ
  - `code`の昇順でソート
  - 「選択しない」オプションあり
- **連動動作**:
  - 都道府県を変更すると、市区町村の選択肢が更新される
  - 都道府県を変更すると、市区町村の選択はリセットされる
  - 都道府県を「選択しない」にすると、市区町村も「選択しない」になる

### 求人投稿管理

#### 求人一覧画面
- **ルート**: `GET /jobs`
- **ルート名**: `jobs.index`
- **コンポーネント**: `resources/views/livewire/jobs/index.blade.php`
- **ミドルウェア**: `auth`
- **機能**: 全求人一覧表示、検索・フィルタ機能
- **表示内容**:
  - 全求人をカード形式で一覧表示
  - 求人タイトル、企業名、勤務地、雇用形態、給与を表示
  - ページネーション: 1ページ20件
- **検索・フィルタ機能**:
  - キーワード検索: タイトル、詳細内容（LIKE検索）
  - 勤務地フィルタ: 2段階選択（都道府県→市区町村、任意）
    - 都道府県: locationsテーブル（`city IS NULL`）、codeの昇順
    - 市区町村: 選択された都道府県に対応する市区町村（`city IS NOT NULL`）、codeの昇順
    - 都道府県を変更すると市区町村がリセット
    - 両方とも「選択しない」オプションあり
  - 雇用形態フィルタ: チェックボックス（codesテーブルtype=1）
  - 勤務形態フィルタ: チェックボックス（codesテーブルtype=2）
  - 業種フィルタ: チェックボックス（codesテーブルtype=3）
- **アクション**:
  - 企業ユーザーのみ: 「新規求人投稿」ボタン表示（jobs.create へ遷移）
  - 全求人カード: クリックで求人詳細画面（jobs.show）へ遷移
- **リレーション**:
  - company（企業）、location（勤務地）を先読み込み（N+1問題回避）

#### 求人詳細画面
- **ルート**: `GET /jobs/{jobPost}`
- **ルート名**: `jobs.show`
- **コンポーネント**: `resources/views/livewire/jobs/show.blade.php`
- **ミドルウェア**: `auth`
- **機能**: 求人詳細表示、応募ボタン、編集・削除ボタン
- **表示内容**:
  - job_postsテーブルの全情報
  - リレーション情報（企業名、雇用形態名、勤務形態名、業種名、勤務地名）
- **アクション**:
  - ワーカーユーザー: 「応募する」ボタン（jobs.apply へ遷移、次章で実装）
  - 企業ユーザー（自社求人のみ）: 「編集」ボタン（jobs.edit へ遷移）
  - 企業ユーザー（自社求人のみ）: 「削除」ボタン（削除確認モーダル表示）
- **削除機能**:
  - 削除確認モーダル表示
  - 削除後は求人一覧（jobs.index）にリダイレクト
- **ポリシー**: `view`アクション（誰でも閲覧可能）
- **リレーション**:
  - company、employmentType、workStyle、industry、locationを先読み込み

#### 求人登録画面
- **ルート**: `GET /jobs/create`
- **ルート名**: `jobs.create`
- **コンポーネント**: `resources/views/livewire/jobs/create.blade.php`
- **ミドルウェア**: `auth`, `role:company`
- **機能**: 新規求人投稿
- **入力項目**:
  - title: 求人タイトル（必須、100文字以内）
  - description: 詳細内容（必須、1000文字以内、テキストエリア）
  - employment_type_id: 雇用形態（必須、ドロップダウン、codesテーブルtype=1）
  - work_style_id: 勤務形態（必須、ドロップダウン、codesテーブルtype=2）
  - industry_id: 業種（必須、ドロップダウン、codesテーブルtype=3）
  - location_id: 勤務地（必須、2段階選択）
    - 第1段階: prefecture_id（都道府県、ドロップダウン、prefecturesテーブル）
    - 第2段階: location_id（市区町村、ドロップダウン、locationsテーブル、選択した都道府県に応じて動的に絞り込み）
  - working_hours: 勤務時間（必須、100文字以内）
  - salary: 給与（必須、0以上の整数）
  - number_of_positions: 募集人数（必須、1以上の整数）
  - expires_at: 募集期限（任意、日付、今日より後）
- **自動設定項目**:
  - company_id: ログインユーザーのID
  - posted_at: 現在日時
- **バリデーション**（Form Request使用）:
  - title: required, max:100
  - description: required, max:1000
  - employment_type_id: required, exists:codes,type_id（type=1の範囲内）
  - work_style_id: required, exists:codes,type_id（type=2の範囲内）
  - industry_id: required, exists:codes,type_id（type=3の範囲内）
  - location_id: required, exists:locations,id
  - working_hours: required, max:100
  - salary: required, integer, min:0
  - number_of_positions: required, integer, min:1
  - expires_at: nullable, date, after:today
- **処理**:
  - バリデーション後、job_postsテーブルに登録
  - 登録成功後、求人一覧（jobs.index）にリダイレクト
- **ポリシー**: `create`アクション（企業ユーザーのみ）
- **2段階選択の実装**:
  - 都道府県選択時に`wire:model.live="prefecture_id"`を使用
  - prefecture_idが変更されたら市区町村ドロップダウンを動的に更新
  - 市区町村はupdatedPrefectureId()メソッド内で絞り込み

#### 求人編集画面
- **ルート**: `GET /jobs/{jobPost}/edit`
- **ルート名**: `jobs.edit`
- **コンポーネント**: `resources/views/livewire/jobs/edit.blade.php`
- **ミドルウェア**: `auth`, `role:company`
- **機能**: 既存求人の編集（自社求人のみ）
- **入力項目**: 求人登録画面と同じ
- **既存データ**: プリフィル（初期表示）
  - 勤務地は既存location_idから都道府県と市区町村を取得して表示
- **posted_at**: 編集時は更新しない（既存値を保持）
- **バリデーション**: 求人登録画面と同じ
- **処理**:
  - バリデーション後、job_postsテーブルを更新
  - 更新成功後、求人詳細（jobs.show）にリダイレクト
- **ポリシー**: `update`アクション（自社求人のみ）
- **2段階選択の実装**:
  - 都道府県選択時に`wire:model.live="prefecture_id"`を使用
  - prefecture_idが変更されたら市区町村ドロップダウンを動的に更新
  - 市区町村はupdatedPrefectureId()メソッド内で絞り込み
  - mount時に既存のlocation_idから都道府県IDを取得してprefecture_idを設定

### 応募管理

#### 応募画面（ワーカー向け）
- **ルート**: `GET /jobs/{jobPost}/apply`
- **ルート名**: `jobs.apply`
- **コンポーネント**: `resources/views/livewire/jobs/apply.blade.php`
- **ミドルウェア**: `auth`, `role:worker`
- **機能**: 求人への応募
- **表示内容**:
  - 求人情報のサマリー（タイトル、企業名、雇用形態、給与など）
  - 志望動機入力欄（textarea）
- **重複応募チェック**:
  - 既に応募済みの場合は応募不可（ポリシーで制御）
  - 応募画面にアクセスした時点で応募済みの場合はエラーまたはリダイレクト
- **入力項目**:
  - motive: 志望動機（任意、1000文字以内、テキストエリア）
- **応募確認モーダル**:
  - 「応募する」ボタンクリック時に確認モーダル表示
  - 「本当に応募しますか？」
- **自動設定項目**:
  - job_id: パラメータから取得
  - worker_id: ログインユーザーID
  - status: 'applied'
  - applied_at: 現在日時
- **バリデーション**（Form Request使用）:
  - motive: nullable, max:1000
- **処理**:
  - バリデーション後、job_applicationsテーブルに登録
  - 登録成功後、求人詳細画面（jobs.show）にリダイレクト
- **ポリシー**: `create`アクション（ワーカーのみ、重複応募不可）

#### 応募済み表示機能（既存画面の更新）
- **対象画面**: 
  - 求人一覧画面（jobs.index）
  - 求人詳細画面（jobs.show）
- **ワーカーユーザーのみ表示**:
  - ログインユーザーが応募済みの求人に「応募済み」バッジを表示
  - バッジは目立つ色（例: 青、緑）で表示
- **求人一覧画面での表示**:
  - 各求人カードに応募済みバッジを表示（応募済みの場合のみ）
  - カード右上または適切な位置に配置
- **求人詳細画面での表示**:
  - 応募済みの場合、「応募する」ボタンの代わりに「応募済み」バッジを表示
  - または「応募する」ボタンを無効化し、その横に「応募済み」バッジを表示
  - 応募済みの場合、「応募する」ボタンをクリックできないようにする
- **実装方法**:
  - ワーカーユーザーの場合、ログインユーザーの応募状況を確認
  - `JobApplication::where('job_id', $jobPost->id)->where('worker_id', auth()->id())->exists()`
  - 求人一覧では、N+1問題回避のため応募データを先読み込み
  - `JobPost::with(['applications' => fn($q) => $q->where('worker_id', auth()->id())])`

#### 応募一覧画面（ワーカー向け）
- **ルート**: `GET /applications`
- **ルート名**: `applications.index`
- **コンポーネント**: `resources/views/livewire/applications/index.blade.php`
- **ミドルウェア**: `auth`, `role:worker`
- **機能**: 自分の応募履歴一覧表示、検索・フィルタ機能
- **表示内容**:
  - 自分が応募した求人のリスト（1ページ20件）
  - 求人タイトル、企業名、雇用形態、勤務地、給与
  - ステータス（バッジ）
  - 応募日
  - 判定日（承認/不承認の場合のみ）
- **検索・フィルタ機能**:
  - ステータスフィルタ（チェックボックス、applied, accepted, rejected, declined）
  - キーワード検索（求人タイトル、企業名）
  - 並び替え（応募日の新しい順/古い順）
- **ページネーション**: 1ページ20件
- **アクション**:
  - 詳細ボタン（常に表示、applications.showへ遷移）
- **パフォーマンス**: N+1問題対策（`with(['jobPost.company', 'jobPost.employmentType', 'jobPost.location'])`）

#### 応募詳細画面（ワーカー向け）
- **ルート**: `GET /applications/{jobApplication}`
- **ルート名**: `applications.show`
- **コンポーネント**: `resources/views/livewire/applications/show.blade.php`
- **ミドルウェア**: `auth`（workerとcompany共通）
- **機能**: 応募詳細表示、辞退機能（ワーカー）、承認・不承認機能（企業、13.mdで追加）
- **表示内容**:
  - 応募情報（応募日、ステータス、判定日、辞退日）
  - 求人情報（タイトル、企業名、雇用形態、勤務地、給与、勤務時間、詳細内容など）
  - 志望動機
- **アクション**:
  - 辞退ボタン（status='applied'の場合のみ）
  - 辞退確認モーダル（「本当に辞退しますか？」）
- **辞退処理**:
  - statusを'declined'に更新
  - declined_atに現在日時を設定
  - 処理後、応募一覧（applications.index）にリダイレクト
- **ポリシー**: `view`アクション（自分の応募のみ閲覧可能）
- **パフォーマンス**: N+1問題対策（`with(['jobPost.company', 'jobPost.employmentType', 'jobPost.workStyle', 'jobPost.industry', 'jobPost.location'])`）
